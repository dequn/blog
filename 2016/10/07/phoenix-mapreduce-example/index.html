<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="最近有点孤僻"><title>用 Phoenix 跑 MapReduce 任务-官方例子 | dequn's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-105163669-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">用 Phoenix 跑 MapReduce 任务-官方例子</h1><a id="logo" href="/.">dequn's blog</a><p class="description">最近有点孤僻</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">用 Phoenix 跑 MapReduce 任务-官方例子</h1><div class="post-meta">Oct 7, 2016<span> | </span><span class="category"><a href="/categories/Phoenix/">Phoenix</a></span></div><a data-disqus-identifier="2016/10/07/phoenix-mapreduce-example/" href="/2016/10/07/phoenix-mapreduce-example/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>Phoenix 提供了 MapReduce 工作任务的支持，并且官方给出了例子，一起来编码运行一下。</p>
<h1 id="1新建-maven-工程"><a href="#1新建-maven-工程" class="headerlink" title="1新建 maven 工程"></a>1新建 maven 工程</h1><p>在 pom.xml 中添加以下内容：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.phoenix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>phoenix-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.7.0-HBase-1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h1 id="2新建一个-StockWritable-的-Java-类"><a href="#2新建一个-StockWritable-的-Java-类" class="headerlink" title="2新建一个 StockWritable 的 Java 类"></a>2新建一个 <code>StockWritable</code> 的 Java 类</h1><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Writable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.db.DBWritable;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.DataInput;</div><div class="line"><span class="keyword">import</span> java.io.DataOutput;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</div><div class="line"><span class="keyword">import</span> java.sql.ResultSet;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by dq on 10/7/16.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockWritable</span> <span class="keyword">implements</span> <span class="title">DBWritable</span>, <span class="title">Writable</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> String stockName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStockName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stockName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStockName</span><span class="params">(String stockName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.stockName = stockName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getYear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> year;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.year = year;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">double</span>[] getRecordings() &#123;</div><div class="line">        <span class="keyword">return</span> recordings;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRecordings</span><span class="params">(<span class="keyword">double</span>[] recordings)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.recordings = recordings;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMaxPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> maxPrice;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxPrice</span><span class="params">(<span class="keyword">double</span> maxPrice)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.maxPrice = maxPrice;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> year;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span>[] recordings;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> maxPrice;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(PreparedStatement preparedStatement)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"></div><div class="line">        preparedStatement.setString(<span class="number">1</span>, <span class="keyword">this</span>.stockName);</div><div class="line">        preparedStatement.setDouble(<span class="number">2</span>, <span class="keyword">this</span>.maxPrice);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.stockName = resultSet.getString(<span class="string">"STOCK_NAME"</span>);</div><div class="line">        <span class="keyword">this</span>.year = resultSet.getInt(<span class="string">"RECORDING_YEAR"</span>);</div><div class="line">        <span class="keyword">this</span>.recordings = (<span class="keyword">double</span>[]) resultSet.getArray(<span class="string">"RECORDINGS_QUARTER"</span>).getArray();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3Mapper-Reducer"><a href="#3Mapper-Reducer" class="headerlink" title="3Mapper, Reducer"></a>3Mapper, Reducer</h1><p>新建一个 PhoenixMapRed 类，实现 map(), reduce(), 并且添加主函数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.<span class="type">Configuration</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.<span class="type">HBaseConfiguration</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.<span class="type">TableMapReduceUtil</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">DoubleWritable</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">NullWritable</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">Text</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Job</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Mapper</span>;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Reducer</span>;</div><div class="line"><span class="keyword">import</span> org.apache.phoenix.mapreduce.<span class="type">PhoenixOutputFormat</span>;</div><div class="line"><span class="keyword">import</span> org.apache.phoenix.mapreduce.util.<span class="type">PhoenixMapReduceUtil</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.<span class="type">IOException</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by dq on 10/7/16.</span></div><div class="line"><span class="comment"> */</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PhoenixMapRed</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    public static <span class="class"><span class="keyword">class</span> <span class="title">StockMapper</span> <span class="keyword">extends</span> <span class="title">Mapper&lt;NullWritable</span>, <span class="title">StockWritable</span>, <span class="title">Text</span>, <span class="title">DoubleWritable&gt;</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="type">Text</span> stock = <span class="keyword">new</span> <span class="type">Text</span>();</div><div class="line">        <span class="type">DoubleWritable</span> price = <span class="keyword">new</span> <span class="type">DoubleWritable</span>();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">protected</span> void map(<span class="type">NullWritable</span> key, <span class="type">StockWritable</span> value, <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</div><div class="line"></div><div class="line">            <span class="type">String</span> name = value.getStockName();</div><div class="line">            double[] recordings = value.getRecordings();</div><div class="line"></div><div class="line">            double maxRecording = <span class="type">Double</span>.<span class="type">MIN_VALUE</span>;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (double d : recordings) &#123;</div><div class="line">                maxRecording = <span class="type">Math</span>.max(maxRecording, d);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            stock.set(name);</div><div class="line">            price.set(maxRecording);</div><div class="line"></div><div class="line">            context.write(stock, price);</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="class"><span class="keyword">class</span> <span class="title">StockReducer</span> <span class="keyword">extends</span> <span class="title">Reducer&lt;Text</span>, <span class="title">DoubleWritable</span>, <span class="title">NullWritable</span>, <span class="title">StockWritable&gt;</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">protected</span> void reduce(<span class="type">Text</span> key, <span class="type">Iterable</span>&lt;<span class="type">DoubleWritable</span>&gt; values, <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</div><div class="line"></div><div class="line">            double maxPrice = <span class="type">Double</span>.<span class="type">MIN_VALUE</span>;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="type">DoubleWritable</span> <span class="keyword">val</span> : values) &#123;</div><div class="line">                maxPrice = <span class="type">Math</span>.max(maxPrice, <span class="keyword">val</span>.get());</div><div class="line">            &#125;</div><div class="line">            <span class="type">StockWritable</span> stockWritable = <span class="keyword">new</span> <span class="type">StockWritable</span>();</div><div class="line">            stockWritable.setStockName(key.toString());</div><div class="line">            stockWritable.setMaxPrice(maxPrice);</div><div class="line"></div><div class="line">            context.write(<span class="type">NullWritable</span>.get(), stockWritable);</div><div class="line"></div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    public static void main(<span class="type">String</span>[] args) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">ClassNotFoundException</span>, <span class="type">InterruptedException</span> &#123;</div><div class="line"></div><div class="line">        <span class="type">Configuration</span> conf = <span class="type">HBaseConfiguration</span>.create();</div><div class="line"></div><div class="line">        <span class="type">Job</span> job = <span class="type">Job</span>.getInstance(conf, <span class="string">"stock"</span>);</div><div class="line"></div><div class="line">        <span class="type">String</span> selectQuery = <span class="string">"SELECT STOCK_NAME,RECORDING_YEAR,RECORDINGS_QUARTER FROM STOCK "</span>;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="type">PhoenixMapReduceUtil</span>.setInput(job, <span class="type">StockWritable</span>.<span class="keyword">class</span>, <span class="string">"STOCK"</span>, selectQuery);</div><div class="line">        <span class="type">PhoenixMapReduceUtil</span>.setOutput(job, <span class="string">"STOCK_STATS"</span>, <span class="string">"STOCK_NAME,MAX_RECORDING"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        job.setMapperClass(<span class="type">StockMapper</span>.<span class="keyword">class</span>);</div><div class="line">        job.setReducerClass(<span class="type">StockReducer</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">        job.setOutputFormatClass(<span class="type">PhoenixOutputFormat</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line"></div><div class="line">        job.setMapOutputKeyClass(<span class="type">Text</span>.<span class="keyword">class</span>);</div><div class="line">        job.setMapOutputValueClass(<span class="type">DoubleWritable</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">        job.setOutputKeyClass(<span class="type">NullWritable</span>.<span class="keyword">class</span>);</div><div class="line">        job.setOutputValueClass(<span class="type">StockWritable</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="type">TableMapReduceUtil</span>.addDependencyJars(job);</div><div class="line">        job.waitForCompletion(<span class="literal">true</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意，代码中的<code>PhoenixMapReduceUtil.setOutput(job, &quot;STOCK_STATS&quot;, &quot;STOCK_NAME,MAX_RECORDING&quot;);</code>一句与官方文档不一样，官方上的应该是老代码，运行时有错误。</strong></p>
<h1 id="4数据表建立，数据导入，略。"><a href="#4数据表建立，数据导入，略。" class="headerlink" title="4数据表建立，数据导入，略。"></a>4数据表建立，数据导入，略。</h1><h1 id="5编译"><a href="#5编译" class="headerlink" title="5编译"></a>5编译</h1><p>编译的过程是一个比较复杂的过程，官方的例子并没有给出过程，在使用<code>javac</code>编译前，需要将<code>phoenix-4.8.0-HBase-1.1-client.jar</code>添加到<code>CLASSPATH</code>中,编译后会生成4个文件，再使用 <code>jar</code>命令生成 .jar 文件。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export CLASSPATH=/usr/local/hbase/lib/phoenix-<span class="number">4.8</span>.<span class="number">0</span>-HBase-<span class="number">1.1</span>-client<span class="selector-class">.jar</span>:<span class="variable">$CLASSPATH</span></div><div class="line"></div><div class="line">javac PhoenixMapRed.java</div><div class="line">#生成<span class="number">4</span>个文件 PhoenixMapRed<span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockMapper</span><span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockReducer</span><span class="selector-class">.class</span>  StockWritable.class</div><div class="line"></div><div class="line">jar -cvf PhoenixMapRed<span class="selector-class">.jar</span> PhoenixMapRed<span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockMapper</span><span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockReducer</span><span class="selector-class">.class</span>  StockWritable.class</div></pre></td></tr></table></figure>
<h1 id="6运行"><a href="#6运行" class="headerlink" title="6运行"></a>6运行</h1><p>如果现在直接执行<code>hadoop jar PhoenixMapRed.jar PhoenixMapRed</code>的话，会抛出异常：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="selector-class">.lang</span><span class="selector-class">.NoClassDefFoundError</span>: org/apache/hadoop/hbase/HBaseConfiguration</div><div class="line">	at PhoenixMapRed.main(PhoenixMapRed<span class="selector-class">.java</span>:<span class="number">73</span>)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">62</span>)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</div><div class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">498</span>)</div><div class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.util</span><span class="selector-class">.RunJar</span><span class="selector-class">.run</span>(RunJar<span class="selector-class">.java</span>:<span class="number">221</span>)</div><div class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.util</span><span class="selector-class">.RunJar</span><span class="selector-class">.main</span>(RunJar<span class="selector-class">.java</span>:<span class="number">136</span>)</div><div class="line">Caused by: java<span class="selector-class">.lang</span><span class="selector-class">.ClassNotFoundException</span>: org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hbase</span><span class="selector-class">.HBaseConfiguration</span></div><div class="line">	at java<span class="selector-class">.net</span><span class="selector-class">.URLClassLoader</span><span class="selector-class">.findClass</span>(URLClassLoader<span class="selector-class">.java</span>:<span class="number">381</span>)</div><div class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ClassLoader</span><span class="selector-class">.loadClass</span>(ClassLoader<span class="selector-class">.java</span>:<span class="number">424</span>)</div><div class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ClassLoader</span><span class="selector-class">.loadClass</span>(ClassLoader<span class="selector-class">.java</span>:<span class="number">357</span>)</div></pre></td></tr></table></figure>
<p>这次需要将<code>phoenix-4.8.0-HBase-1.1-client.jar</code>添加到 <code>HADOOP_CLASSPATH</code>中，然后再执行任务。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="builtin-name">export</span> <span class="attribute">HADOOP_CLASSPATH</span>=/usr/local/hbase/lib/phoenix-4.8.0-HBase-1.1-client.jar:$HADOOP_CLASSPATH</div><div class="line">hadoop jar PhoenixMapRed.jar PhoenixMapRed</div><div class="line"><span class="comment">#...执行正常</span></div></pre></td></tr></table></figure>
<h1 id="7结果查看"><a href="#7结果查看" class="headerlink" title="7结果查看"></a>7结果查看</h1><p>在phoenix 的 sqlline 环境中执行查询，会看到结果</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0: jdbc:phoenix:localhost&gt; select * from stock<span class="emphasis">_stats;</span></div><div class="line"><span class="emphasis">+-------------+----------------+</span></div><div class="line"><span class="emphasis">| STOCK_</span>NAME  | MAX<span class="emphasis">_RECORDING  |</span></div><div class="line"><span class="emphasis">+-------------+----------------+</span></div><div class="line"><span class="emphasis">| AAPL        | 200.26         |</span></div><div class="line"><span class="emphasis">| CSCO        | 27.98          |</span></div><div class="line"><span class="emphasis">| GOOG        | 697.37         |</span></div><div class="line"><span class="emphasis">| MSFT        | 35.96          |</span></div><div class="line"><span class="emphasis">| YHOO        | 41.22          |</span></div><div class="line"><span class="emphasis">+-------------+----------------+</span></div><div class="line"><span class="emphasis">5 rows selected (0.298 seconds)</span></div></pre></td></tr></table></figure>
<p>至此，该例子成功运行。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>1.<a href="http://phoenix.apache.org/phoenix_mr.html" target="_blank" rel="external">Phoenix Map Reduce</a><br>2.<a href="http://stackoverflow.com/questions/30801364/mapreduce-hadoop-2-6-0-hbase-1-0-1-1-class-not-found-exception" target="_blank" rel="external">MapReduce (Hadoop-2.6.0)+ HBase-1.0.1.1 class not found exception</a></p>
</div><div class="tags"><a href="/tags/Phoenix/">Phoenix</a><a href="/tags/MapReduce/">MapReduce</a></div><div class="post-nav"><a href="/2016/10/27/mapreduce-output-to-hbase-at-mapper-phase-without-reducer/" class="pre">MapReduce 在 Map 阶段写数据库，没有 Reducer</a><a href="/2016/09/02/Phoenix-Secondary-Index-Exploration-Local-Index/" class="next">Phoenix Secondary Index初探之Local Index</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'dequn-blog';
var disqus_identifier = '2016/10/07/phoenix-mapreduce-example/';
var disqus_title = '用 Phoenix 跑 MapReduce 任务-官方例子';
var disqus_url = 'http://dequn.github.io/2016/10/07/phoenix-mapreduce-example/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//dequn-blog.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://dequn.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/">Development</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Phoenix/">Phoenix</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zeppelin/">Zeppelin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/个人日记/">个人日记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/d3/" style="font-size: 15px;">d3</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/Secondary-Index/" style="font-size: 15px;">Secondary Index</a> <a href="/tags/hindex/" style="font-size: 15px;">hindex</a> <a href="/tags/Phoenix/" style="font-size: 15px;">Phoenix</a> <a href="/tags/Global-Index/" style="font-size: 15px;">Global Index</a> <a href="/tags/Local-Index/" style="font-size: 15px;">Local Index</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/filter/" style="font-size: 15px;">filter</a> <a href="/tags/Controller/" style="font-size: 15px;">Controller</a> <a href="/tags/多级联动/" style="font-size: 15px;">多级联动</a> <a href="/tags/httpbackend/" style="font-size: 15px;">$httpbackend</a> <a href="/tags/ui-router/" style="font-size: 15px;">ui-router</a> <a href="/tags/charset/" style="font-size: 15px;">charset</a> <a href="/tags/encode/" style="font-size: 15px;">encode</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/Intellij-IDEA/" style="font-size: 15px;">Intellij IDEA</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Endpoint/" style="font-size: 15px;">Endpoint</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/MapReduce/" style="font-size: 15px;">MapReduce</a> <a href="/tags/pyenv/" style="font-size: 15px;">pyenv</a> <a href="/tags/任性/" style="font-size: 15px;">任性</a> <a href="/tags/Interceptor/" style="font-size: 15px;">Interceptor</a> <a href="/tags/RowFilter/" style="font-size: 15px;">RowFilter</a> <a href="/tags/zeppelin/" style="font-size: 15px;">zeppelin</a> <a href="/tags/phoenix/" style="font-size: 15px;">phoenix</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/19/charset-encoding-and-in-python/">字符集、字符编码以及Python中编码的那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/31/d3-example-of-different-data-structures/">d3-example-of-different-data-structures</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/27/jiu-zhe-teng-dao-zhe-er-ba/">就折腾到这儿吧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/20/zeppelin-installation-and-settings/">Zeppelin 安装配置的一些问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/debug-spark-in-intellij/">Intellij IDEA 中调试 Spark Application</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/08/phoenix-spark-setting/">Spark 连接 Phoenix 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/02/pyenv-install-with-warnings/">pyenv安装多版本 Python 过程中提示警告</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/28/macvim-auto-im/">macvim自动切换中英文输入法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/27/mapreduce-output-to-hbase-at-mapper-phase-without-reducer/">MapReduce 在 Map 阶段写数据库，没有 Reducer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/07/phoenix-mapreduce-example/">用 Phoenix 跑 MapReduce 任务-官方例子</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//dequn-blog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">dequn's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>