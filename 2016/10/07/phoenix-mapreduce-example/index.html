<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这些文章没啥用"><title>用 Phoenix 跑 MapReduce 任务-官方例子 | dequn's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-105163669-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">用 Phoenix 跑 MapReduce 任务-官方例子</h1><a id="logo" href="/.">dequn's blog</a><p class="description">这些文章没啥用</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">用 Phoenix 跑 MapReduce 任务-官方例子</h1><div class="post-meta">Oct 7, 2016<span> | </span><span class="category"><a href="/categories/Phoenix/">Phoenix</a></span></div><a data-disqus-identifier="2016/10/07/phoenix-mapreduce-example/" href="/2016/10/07/phoenix-mapreduce-example/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>Phoenix 提供了 MapReduce 工作任务的支持，并且官方给出了例子，一起来编码运行一下。</p>
<h1 id="1新建-maven-工程"><a href="#1新建-maven-工程" class="headerlink" title="1新建 maven 工程"></a>1新建 maven 工程</h1><p>在 pom.xml 中添加以下内容：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.phoenix<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>phoenix-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.7.0-HBase-1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="2新建一个-StockWritable-的-Java-类"><a href="#2新建一个-StockWritable-的-Java-类" class="headerlink" title="2新建一个 StockWritable 的 Java 类"></a>2新建一个 <code>StockWritable</code> 的 Java 类</h1><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Writable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.db.DBWritable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataInput;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dq on 10/7/16.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockWritable</span> <span class="keyword">implements</span> <span class="title">DBWritable</span>, <span class="title">Writable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String stockName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStockName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stockName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStockName</span><span class="params">(String stockName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stockName = stockName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getYear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> year;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.year = year;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span>[] getRecordings() &#123;</span><br><span class="line">        <span class="keyword">return</span> recordings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRecordings</span><span class="params">(<span class="keyword">double</span>[] recordings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.recordings = recordings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMaxPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> maxPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxPrice</span><span class="params">(<span class="keyword">double</span> maxPrice)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxPrice = maxPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> year;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span>[] recordings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> maxPrice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(PreparedStatement preparedStatement)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        preparedStatement.setString(<span class="number">1</span>, <span class="keyword">this</span>.stockName);</span><br><span class="line">        preparedStatement.setDouble(<span class="number">2</span>, <span class="keyword">this</span>.maxPrice);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.stockName = resultSet.getString(<span class="string">"STOCK_NAME"</span>);</span><br><span class="line">        <span class="keyword">this</span>.year = resultSet.getInt(<span class="string">"RECORDING_YEAR"</span>);</span><br><span class="line">        <span class="keyword">this</span>.recordings = (<span class="keyword">double</span>[]) resultSet.getArray(<span class="string">"RECORDINGS_QUARTER"</span>).getArray();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3Mapper-Reducer"><a href="#3Mapper-Reducer" class="headerlink" title="3Mapper, Reducer"></a>3Mapper, Reducer</h1><p>新建一个 PhoenixMapRed 类，实现 map(), reduce(), 并且添加主函数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.<span class="type">Configuration</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.<span class="type">HBaseConfiguration</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.<span class="type">TableMapReduceUtil</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">DoubleWritable</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">NullWritable</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">Text</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Job</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Mapper</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.<span class="type">Reducer</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.phoenix.mapreduce.<span class="type">PhoenixOutputFormat</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.phoenix.mapreduce.util.<span class="type">PhoenixMapReduceUtil</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.<span class="type">IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by dq on 10/7/16.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PhoenixMapRed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static <span class="class"><span class="keyword">class</span> <span class="title">StockMapper</span> <span class="keyword">extends</span> <span class="title">Mapper&lt;NullWritable</span>, <span class="title">StockWritable</span>, <span class="title">Text</span>, <span class="title">DoubleWritable&gt;</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Text</span> stock = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line">        <span class="type">DoubleWritable</span> price = <span class="keyword">new</span> <span class="type">DoubleWritable</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> void map(<span class="type">NullWritable</span> key, <span class="type">StockWritable</span> value, <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> name = value.getStockName();</span><br><span class="line">            double[] recordings = value.getRecordings();</span><br><span class="line"></span><br><span class="line">            double maxRecording = <span class="type">Double</span>.<span class="type">MIN_VALUE</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (double d : recordings) &#123;</span><br><span class="line">                maxRecording = <span class="type">Math</span>.max(maxRecording, d);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stock.set(name);</span><br><span class="line">            price.set(maxRecording);</span><br><span class="line"></span><br><span class="line">            context.write(stock, price);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static <span class="class"><span class="keyword">class</span> <span class="title">StockReducer</span> <span class="keyword">extends</span> <span class="title">Reducer&lt;Text</span>, <span class="title">DoubleWritable</span>, <span class="title">NullWritable</span>, <span class="title">StockWritable&gt;</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> void reduce(<span class="type">Text</span> key, <span class="type">Iterable</span>&lt;<span class="type">DoubleWritable</span>&gt; values, <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line"></span><br><span class="line">            double maxPrice = <span class="type">Double</span>.<span class="type">MIN_VALUE</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">DoubleWritable</span> <span class="keyword">val</span> : values) &#123;</span><br><span class="line">                maxPrice = <span class="type">Math</span>.max(maxPrice, <span class="keyword">val</span>.get());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">StockWritable</span> stockWritable = <span class="keyword">new</span> <span class="type">StockWritable</span>();</span><br><span class="line">            stockWritable.setStockName(key.toString());</span><br><span class="line">            stockWritable.setMaxPrice(maxPrice);</span><br><span class="line"></span><br><span class="line">            context.write(<span class="type">NullWritable</span>.get(), stockWritable);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(<span class="type">String</span>[] args) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">ClassNotFoundException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Configuration</span> conf = <span class="type">HBaseConfiguration</span>.create();</span><br><span class="line"></span><br><span class="line">        <span class="type">Job</span> job = <span class="type">Job</span>.getInstance(conf, <span class="string">"stock"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> selectQuery = <span class="string">"SELECT STOCK_NAME,RECORDING_YEAR,RECORDINGS_QUARTER FROM STOCK "</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">PhoenixMapReduceUtil</span>.setInput(job, <span class="type">StockWritable</span>.<span class="keyword">class</span>, <span class="string">"STOCK"</span>, selectQuery);</span><br><span class="line">        <span class="type">PhoenixMapReduceUtil</span>.setOutput(job, <span class="string">"STOCK_STATS"</span>, <span class="string">"STOCK_NAME,MAX_RECORDING"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        job.setMapperClass(<span class="type">StockMapper</span>.<span class="keyword">class</span>);</span><br><span class="line">        job.setReducerClass(<span class="type">StockReducer</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">        job.setOutputFormatClass(<span class="type">PhoenixOutputFormat</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        job.setMapOutputKeyClass(<span class="type">Text</span>.<span class="keyword">class</span>);</span><br><span class="line">        job.setMapOutputValueClass(<span class="type">DoubleWritable</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">        job.setOutputKeyClass(<span class="type">NullWritable</span>.<span class="keyword">class</span>);</span><br><span class="line">        job.setOutputValueClass(<span class="type">StockWritable</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TableMapReduceUtil</span>.addDependencyJars(job);</span><br><span class="line">        job.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意，代码中的<code>PhoenixMapReduceUtil.setOutput(job, &quot;STOCK_STATS&quot;, &quot;STOCK_NAME,MAX_RECORDING&quot;);</code>一句与官方文档不一样，官方上的应该是老代码，运行时有错误。</strong></p>
<h1 id="4数据表建立，数据导入，略。"><a href="#4数据表建立，数据导入，略。" class="headerlink" title="4数据表建立，数据导入，略。"></a>4数据表建立，数据导入，略。</h1><h1 id="5编译"><a href="#5编译" class="headerlink" title="5编译"></a>5编译</h1><p>编译的过程是一个比较复杂的过程，官方的例子并没有给出过程，在使用<code>javac</code>编译前，需要将<code>phoenix-4.8.0-HBase-1.1-client.jar</code>添加到<code>CLASSPATH</code>中,编译后会生成4个文件，再使用 <code>jar</code>命令生成 .jar 文件。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export CLASSPATH=/usr/local/hbase/lib/phoenix-<span class="number">4.8</span>.<span class="number">0</span>-HBase-<span class="number">1.1</span>-client<span class="selector-class">.jar</span>:<span class="variable">$CLASSPATH</span></span><br><span class="line"></span><br><span class="line">javac PhoenixMapRed.java</span><br><span class="line">#生成<span class="number">4</span>个文件 PhoenixMapRed<span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockMapper</span><span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockReducer</span><span class="selector-class">.class</span>  StockWritable.class</span><br><span class="line"></span><br><span class="line">jar -cvf PhoenixMapRed<span class="selector-class">.jar</span> PhoenixMapRed<span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockMapper</span><span class="selector-class">.class</span> PhoenixMapRed<span class="variable">$StockReducer</span><span class="selector-class">.class</span>  StockWritable.class</span><br></pre></td></tr></table></figure>
<h1 id="6运行"><a href="#6运行" class="headerlink" title="6运行"></a>6运行</h1><p>如果现在直接执行<code>hadoop jar PhoenixMapRed.jar PhoenixMapRed</code>的话，会抛出异常：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="selector-class">.lang</span><span class="selector-class">.NoClassDefFoundError</span>: org/apache/hadoop/hbase/HBaseConfiguration</span><br><span class="line">	at PhoenixMapRed.main(PhoenixMapRed<span class="selector-class">.java</span>:<span class="number">73</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">62</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">498</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.util</span><span class="selector-class">.RunJar</span><span class="selector-class">.run</span>(RunJar<span class="selector-class">.java</span>:<span class="number">221</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.util</span><span class="selector-class">.RunJar</span><span class="selector-class">.main</span>(RunJar<span class="selector-class">.java</span>:<span class="number">136</span>)</span><br><span class="line">Caused by: java<span class="selector-class">.lang</span><span class="selector-class">.ClassNotFoundException</span>: org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hbase</span><span class="selector-class">.HBaseConfiguration</span></span><br><span class="line">	at java<span class="selector-class">.net</span><span class="selector-class">.URLClassLoader</span><span class="selector-class">.findClass</span>(URLClassLoader<span class="selector-class">.java</span>:<span class="number">381</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ClassLoader</span><span class="selector-class">.loadClass</span>(ClassLoader<span class="selector-class">.java</span>:<span class="number">424</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ClassLoader</span><span class="selector-class">.loadClass</span>(ClassLoader<span class="selector-class">.java</span>:<span class="number">357</span>)</span><br></pre></td></tr></table></figure>
<p>这次需要将<code>phoenix-4.8.0-HBase-1.1-client.jar</code>添加到 <code>HADOOP_CLASSPATH</code>中，然后再执行任务。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">HADOOP_CLASSPATH</span>=/usr/local/hbase/lib/phoenix-4.8.0-HBase-1.1-client.jar:$HADOOP_CLASSPATH</span><br><span class="line">hadoop jar PhoenixMapRed.jar PhoenixMapRed</span><br><span class="line"><span class="comment">#...执行正常</span></span><br></pre></td></tr></table></figure>
<h1 id="7结果查看"><a href="#7结果查看" class="headerlink" title="7结果查看"></a>7结果查看</h1><p>在phoenix 的 sqlline 环境中执行查询，会看到结果</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:phoenix:localhost&gt; select * from stock<span class="emphasis">_stats;</span></span><br><span class="line"><span class="emphasis">+-------------+----------------+</span></span><br><span class="line"><span class="emphasis">| STOCK_</span>NAME  | MAX<span class="emphasis">_RECORDING  |</span></span><br><span class="line"><span class="emphasis">+-------------+----------------+</span></span><br><span class="line"><span class="emphasis">| AAPL        | 200.26         |</span></span><br><span class="line"><span class="emphasis">| CSCO        | 27.98          |</span></span><br><span class="line"><span class="emphasis">| GOOG        | 697.37         |</span></span><br><span class="line"><span class="emphasis">| MSFT        | 35.96          |</span></span><br><span class="line"><span class="emphasis">| YHOO        | 41.22          |</span></span><br><span class="line"><span class="emphasis">+-------------+----------------+</span></span><br><span class="line"><span class="emphasis">5 rows selected (0.298 seconds)</span></span><br></pre></td></tr></table></figure>
<p>至此，该例子成功运行。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>1.<a href="http://phoenix.apache.org/phoenix_mr.html" target="_blank" rel="noopener">Phoenix Map Reduce</a><br>2.<a href="http://stackoverflow.com/questions/30801364/mapreduce-hadoop-2-6-0-hbase-1-0-1-1-class-not-found-exception" target="_blank" rel="noopener">MapReduce (Hadoop-2.6.0)+ HBase-1.0.1.1 class not found exception</a></p>
</div><div class="tags"><a href="/tags/Phoenix/">Phoenix</a><a href="/tags/MapReduce/">MapReduce</a></div><div class="post-nav"><a href="/2016/10/27/mapreduce-output-to-hbase-at-mapper-phase-without-reducer/" class="pre">MapReduce 在 Map 阶段写数据库，没有 Reducer</a><a href="/2016/09/02/Phoenix-Secondary-Index-Exploration-Local-Index/" class="next">Phoenix Secondary Index初探之Local Index</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'dequn-blog';
var disqus_identifier = '2016/10/07/phoenix-mapreduce-example/';
var disqus_title = '用 Phoenix 跑 MapReduce 任务-官方例子';
var disqus_url = 'http://dequn.github.io/2016/10/07/phoenix-mapreduce-example/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//dequn-blog.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://dequn.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Phoenix/">Phoenix</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zeppelin/">Zeppelin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/twisted/">twisted</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/个人日记/">个人日记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/Secondary-Index/" style="font-size: 15px;">Secondary Index</a> <a href="/tags/hindex/" style="font-size: 15px;">hindex</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/filter/" style="font-size: 15px;">filter</a> <a href="/tags/ShadowsocksX-NG/" style="font-size: 15px;">ShadowsocksX-NG</a> <a href="/tags/kcptun/" style="font-size: 15px;">kcptun</a> <a href="/tags/Controller/" style="font-size: 15px;">Controller</a> <a href="/tags/select-cascding/" style="font-size: 15px;">select-cascding</a> <a href="/tags/ui-router/" style="font-size: 15px;">ui-router</a> <a href="/tags/d3/" style="font-size: 15px;">d3</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/allauth/" style="font-size: 15px;">allauth</a> <a href="/tags/微信/" style="font-size: 15px;">微信</a> <a href="/tags/Celery/" style="font-size: 15px;">Celery</a> <a href="/tags/APScheduler/" style="font-size: 15px;">APScheduler</a> <a href="/tags/twisted/" style="font-size: 15px;">twisted</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Docker-Compose/" style="font-size: 15px;">Docker Compose</a> <a href="/tags/subdirectory/" style="font-size: 15px;">subdirectory</a> <a href="/tags/Channels/" style="font-size: 15px;">Channels</a> <a href="/tags/WebSocket/" style="font-size: 15px;">WebSocket</a> <a href="/tags/IOT/" style="font-size: 15px;">IOT</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/Phoenix/" style="font-size: 15px;">Phoenix</a> <a href="/tags/Local-Index/" style="font-size: 15px;">Local Index</a> <a href="/tags/charset/" style="font-size: 15px;">charset</a> <a href="/tags/encode/" style="font-size: 15px;">encode</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Intellij-IDEA/" style="font-size: 15px;">Intellij IDEA</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Endpoint/" style="font-size: 15px;">Endpoint</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/VIM/" style="font-size: 15px;">VIM</a> <a href="/tags/MacVim/" style="font-size: 15px;">MacVim</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/args/" style="font-size: 15px;">args</a> <a href="/tags/MapReduce/" style="font-size: 15px;">MapReduce</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/pyenv/" style="font-size: 15px;">pyenv</a> <a href="/tags/格式化/" style="font-size: 15px;">格式化</a> <a href="/tags/Interceptor/" style="font-size: 15px;">Interceptor</a> <a href="/tags/RowFilter/" style="font-size: 15px;">RowFilter</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Encoding/" style="font-size: 15px;">Encoding</a> <a href="/tags/import/" style="font-size: 15px;">import</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/PyCharm/" style="font-size: 15px;">PyCharm</a> <a href="/tags/Python3/" style="font-size: 15px;">Python3</a> <a href="/tags/Twisted/" style="font-size: 15px;">Twisted</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/request/" style="font-size: 15px;">request</a> <a href="/tags/职业选择/" style="font-size: 15px;">职业选择</a> <a href="/tags/工作与初心/" style="font-size: 15px;">工作与初心</a> <a href="/tags/Global-Index/" style="font-size: 15px;">Global Index</a> <a href="/tags/Zeppelin/" style="font-size: 15px;">Zeppelin</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/03/yi-ci-ke-pa-de-wu-cao-zuo/">一次可怕的误操作-暨IDE的重要性</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/14/django-add-user-celery-task/">Django添加用户Celery任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/communication-between-twisted-services/">twisted 服务间通信</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/docker-network/">记一次Confluence迁移数据库和Docker network网络修改</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/23/docker-compose-subdirectory-dockerfile/">docker-compose 子目录编译、运行</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/ShadowsocksX-NG-kcptun-settings/">ShadowsocksX-NG kcptun加速配置释疑</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/19/django-channels-websocket-iot-remote-control/">基于Django & Channels & WebSocket & Twisted的物联网远程控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/12/django-allauth-weixin-login/">django-allauth配置微信登陆</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/02/django-celery/">Django2结合Celery添加定时任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/31/python3-twisted-web-client/">python3调用twisted web request的坑</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//dequn-blog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">dequn's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>