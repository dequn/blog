<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这些文章没啥用"><title>HBase RowFilter 的使用误区及如何加快 HBase 查询速度 | dequn's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-105163669-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HBase RowFilter 的使用误区及如何加快 HBase 查询速度</h1><a id="logo" href="/.">dequn's blog</a><p class="description">这些文章没啥用</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">HBase RowFilter 的使用误区及如何加快 HBase 查询速度</h1><div class="post-meta">Aug 24, 2016<span> | </span><span class="category"><a href="/categories/HBase/">HBase</a></span></div><a data-disqus-identifier="2016/08/24/right-way-to-use-hbase-rowfilter_and_accelerate_hbase_query/" href="/2016/08/24/right-way-to-use-hbase-rowfilter_and_accelerate_hbase_query/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>在做实验的时候，对比一下 HBase 与 PostgreSQL的查询速度，发现 PostgreSQL 只需要300毫秒左后的查询放在 HBase 中竟然需要5秒左右，这效率也差太多了吧！也排除了是数据库连接等操作的耗时，这就需要深入的找一下原因了。原 HBase 代码如下,设置了两个 PrefixFilter 用来过滤，目的是找到某一个 mac 从 beginTime 到 endTime 的数据：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FilterList fl = <span class="keyword">new</span> <span class="type">FilterList</span>(FilterList.Operator.MUST_PASS_ALL);<span class="comment">// must between beginTime and endTime</span></span><br><span class="line">BinaryPrefixComparator comp = <span class="keyword">new</span> <span class="type">BinaryPrefixComparator</span>(Bytes.toBytes(<span class="keyword">String</span>.format(<span class="string">"%s%d"</span>, mac, beginTimeStamp)));</span><br><span class="line">RowFilter filter = <span class="keyword">new</span> <span class="type">RowFilter</span>(CompareFilter.CompareOp.GREATER_OR_EQUAL, comp);</span><br><span class="line">BinaryPrefixComparator comp2 = <span class="keyword">new</span> <span class="type">BinaryPrefixComparator</span>(Bytes.toBytes(<span class="keyword">String</span>.format(<span class="string">"%s%d"</span>, mac, endTimeStamp)));</span><br><span class="line">RowFilter filter2 = <span class="keyword">new</span> <span class="type">RowFilter</span>(CompareFilter.CompareOp.LESS_OR_EQUAL, comp2);</span><br><span class="line">fl.addFilter(filter);</span><br><span class="line">fl.addFilter(filter2);</span><br><span class="line">Scan scan = <span class="keyword">new</span> <span class="type">Scan</span>();</span><br><span class="line">scan.setFilter(fl);</span><br><span class="line"><span class="comment">//....other colde here</span></span><br></pre></td></tr></table></figure>
<p>owkey 不是字典有序有索引的吗，查找两个前缀限制夹出来的行应该很快的啊，不然 Rowkey 索引是做什么用的？一步一步找原因，需要搞清楚 Filter 到底是做什么用的！经过一番搜索，在 <a href="http://stackoverflow.com/questions/10942638/should-i-user-prefixfilter-or-rowkey-range-scan-in-hbase" title="Should I user prefixfilter or rowkey range scan in hbase" target="_blank" rel="noopener">StackOverFlow</a> [1] 上找到一个回答，意思是 Filter 是非常慢的，要进行全表扫描的，如果想要快速的查询数据，得设置 STARTROW 和 ENDROW，原文:</p>
<blockquote>
<p>HBase filters - even row filters - are really slow, since in most cases these do a complete table scan, and then filter on those results. Have a look at this discussion: <a href="http://grokbase.com/p/hbase/user/115cg0d7jh/very-slow-scan-performance-using-filters" target="_blank" rel="noopener">http://grokbase.com/p/hbase/user/115cg0d7jh/very-slow-scan-performance-using-filters</a></p>
</blockquote>
<blockquote>
<p>Row key range scans however, are indeed much faster - they do the equivalent of a filtered table scan. This is because the row keys are stored in sorted order (this is one of the basic guarantees of HBase, which is a BigTable-like solution), so the range scans on row keys are very fast. More explanation here: <a href="http://www.quora.com/How-feasible-is-real-time-querying-on-HBase-Can-it-be-achieved-through-a-programming-language-such-as-Python-PHP-or-JSP" target="_blank" rel="noopener">http://www.quora.com/How-feasible-is-real-time-querying-on-HBase-Can-it-be-achieved-through-a-programming-language-such-as-Python-PHP-or-JSP</a></p>
</blockquote>
<blockquote>
<p>UPDATE: turns out that PrefixFilter does do a full table scan until it passes the prefix used in the filter (if it finds it). The recommendation for fast performance using a PrefixFilter seems to be to specify a start_row parameter in addition to the PrefixFilter. See related 2013 discussion on the hbase-user mailing list.</p>
</blockquote>
<p>另外找到一个比较明确的<a href="https://www.ibm.com/support/knowledgecenter/SSPT3X_2.1.2/com.ibm.swg.im.infosphere.biginsights.analyze.doc/doc/r0057923.html" title="IBM Knowledge Center - HBase Module" target="_blank" rel="noopener">解释如下</a> [2]：</p>
<blockquote>
<p>Filters push row selection criteria out to the HBase region servers for processing so that rows can be filtered remotely and in parallel (when more than one region server is involved). Using these functions helps you to avoid sending rows to the client that are not needed.</p>
</blockquote>
<p>好吧，原来是跟我理解的有偏差，这里边的 Filter 作用并不能直接用来索引到要检索的数据，从描述中可以看出，<strong> 只使用 Filter 的话，还是要进行全表扫描，只是符合 Filter 的数据才会被发送到 Client </strong>，从 <a href="https://hbase.apache.org/apidocs/org/apache/hadoop/hbase/filter/RowFilter.html" title="Class RowFilter" target="_blank" rel="noopener">HBase Java API DOC</a> [3]也可以看出：</p>
<blockquote>
<p>If an already known row range needs to be scanned, use CellScanner start and stop rows directly rather than a filter.</p>
</blockquote>
<p>原因找到了，就按照说明添加一个开始行键和结束行健吧,行健根据自己的需要进行设置！</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//....</span></span><br><span class="line">scan.setStartRow(Bytes.toBytes(<span class="keyword">String</span>.<span class="keyword">format</span>(<span class="string">"%s%d0000"</span>, mac, beginTimeStamp)));</span><br><span class="line">scan.setStopRow(Bytes.toBytes(<span class="keyword">String</span>.<span class="keyword">format</span>(<span class="string">"%s%d0300"</span>, mac, endTimeStamp)));</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>经过改进，同样的查询时间就降至毫秒的数量级了。另外还有一个 WhileMatchFilter 的 Warpper 类，作用是自动结束扫描，需要的朋友可以使用一下，可以参见<a href="https://www.safaribooksonline.com/library/view/hbase-the-definitive/9781449314682/ch04.html" title="Very slow Scan performance using Filters" target="_blank" rel="noopener">[4]</a>里边的示例，就知道如何使用了。</p>
<p>总结 ：最大的误区是错误的理解了 Filter 的作用，认为过滤在前，扫描在后，实际过程却是<strong>扫描 -&gt; 过滤</strong>，所以如果要利用 Rowkey 本身的索引，除了 get 指定行健之外，scan 必须指定开始行健和结束行健，不然进行的全部是全表扫描,无论 RowFilter 是 RegexFilter 还是 PrefixFilter 还是其他！</p>
<p>参考：</p>
<ol>
<li><a href="http://stackoverflow.com/questions/10942638/should-i-user-prefixfilter-or-rowkey-range-scan-in-hbase" title="Should I user prefixfilter or rowkey range scan in hbase" target="_blank" rel="noopener">Should I user prefixfilter or rowkey range scan in hbase</a></li>
<li><a href="https://www.ibm.com/support/knowledgecenter/SSPT3X_2.1.2/com.ibm.swg.im.infosphere.biginsights.analyze.doc/doc/r0057923.html" title="IBM Knowledge Center - HBase Module" target="_blank" rel="noopener">IBM Knowledge Center - HBase Module</a></li>
<li><a href="https://hbase.apache.org/apidocs/org/apache/hadoop/hbase/filter/RowFilter.html" title="Class RowFilter" target="_blank" rel="noopener">Class RowFilter</a></li>
<li><a href="https://www.safaribooksonline.com/library/view/hbase-the-definitive/9781449314682/ch04.html" title="Very slow Scan performance using Filters" target="_blank" rel="noopener">Very slow Scan performance using Filters</a></li>
<li><a href="http://grokbase.com/t/hbase/user/118bft6n5v/why-rowfilter-plus-binaryprefixcomparator-solution-is-so-slow" title="[HBase-user] Why RowFilter plus BinaryPrefixComparator solution is so slow" target="_blank" rel="noopener">[HBase-user] Why RowFilter plus BinaryPrefixComparator solution is so slow</a></li>
</ol>
</div><div class="tags"><a href="/tags/HBase/">HBase</a><a href="/tags/RowFilter/">RowFilter</a></div><div class="post-nav"><a href="/2016/08/29/HBase-Secondary-Index-Theory/" class="pre">HBase 二级索引实现原理</a><a href="/2016/07/03/hbase_cannot_find_existing_table/" class="next">HBase 找不到提示已存在的数据表</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'dequn-blog';
var disqus_identifier = '2016/08/24/right-way-to-use-hbase-rowfilter_and_accelerate_hbase_query/';
var disqus_title = 'HBase RowFilter 的使用误区及如何加快 HBase 查询速度';
var disqus_url = 'http://dequn.github.io/2016/08/24/right-way-to-use-hbase-rowfilter_and_accelerate_hbase_query/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//dequn-blog.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://dequn.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Phoenix/">Phoenix</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zeppelin/">Zeppelin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/个人日记/">个人日记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/Secondary-Index/" style="font-size: 15px;">Secondary Index</a> <a href="/tags/hindex/" style="font-size: 15px;">hindex</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/filter/" style="font-size: 15px;">filter</a> <a href="/tags/ShadowsocksX-NG/" style="font-size: 15px;">ShadowsocksX-NG</a> <a href="/tags/kcptun/" style="font-size: 15px;">kcptun</a> <a href="/tags/Controller/" style="font-size: 15px;">Controller</a> <a href="/tags/select-cascding/" style="font-size: 15px;">select-cascding</a> <a href="/tags/ui-router/" style="font-size: 15px;">ui-router</a> <a href="/tags/d3/" style="font-size: 15px;">d3</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/allauth/" style="font-size: 15px;">allauth</a> <a href="/tags/微信/" style="font-size: 15px;">微信</a> <a href="/tags/Celery/" style="font-size: 15px;">Celery</a> <a href="/tags/APScheduler/" style="font-size: 15px;">APScheduler</a> <a href="/tags/Channels/" style="font-size: 15px;">Channels</a> <a href="/tags/WebSocket/" style="font-size: 15px;">WebSocket</a> <a href="/tags/IOT/" style="font-size: 15px;">IOT</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Docker-Compose/" style="font-size: 15px;">Docker Compose</a> <a href="/tags/subdirectory/" style="font-size: 15px;">subdirectory</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/Endpoint/" style="font-size: 15px;">Endpoint</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/VIM/" style="font-size: 15px;">VIM</a> <a href="/tags/MacVim/" style="font-size: 15px;">MacVim</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/MapReduce/" style="font-size: 15px;">MapReduce</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/args/" style="font-size: 15px;">args</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/Phoenix/" style="font-size: 15px;">Phoenix</a> <a href="/tags/pyenv/" style="font-size: 15px;">pyenv</a> <a href="/tags/格式化/" style="font-size: 15px;">格式化</a> <a href="/tags/Python3/" style="font-size: 15px;">Python3</a> <a href="/tags/Twisted/" style="font-size: 15px;">Twisted</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/request/" style="font-size: 15px;">request</a> <a href="/tags/Interceptor/" style="font-size: 15px;">Interceptor</a> <a href="/tags/RowFilter/" style="font-size: 15px;">RowFilter</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Encoding/" style="font-size: 15px;">Encoding</a> <a href="/tags/import/" style="font-size: 15px;">import</a> <a href="/tags/职业选择/" style="font-size: 15px;">职业选择</a> <a href="/tags/工作与初心/" style="font-size: 15px;">工作与初心</a> <a href="/tags/Local-Index/" style="font-size: 15px;">Local Index</a> <a href="/tags/charset/" style="font-size: 15px;">charset</a> <a href="/tags/encode/" style="font-size: 15px;">encode</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Intellij-IDEA/" style="font-size: 15px;">Intellij IDEA</a> <a href="/tags/Zeppelin/" style="font-size: 15px;">Zeppelin</a> <a href="/tags/Global-Index/" style="font-size: 15px;">Global Index</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/23/docker-compose-subdirectory-dockerfile/">docker-compose 子目录编译、运行</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/21/ShadowsocksX-NG-kcptun-settings/">ShadowsocksX-NG kcptun加速配置释疑</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/19/django-channels-websocket-iot-remote-control/">基于Django & Channels & WebSocket & Twisted的物联网远程控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/12/django-allauth-weixin-login/">django-allauth配置微信登陆</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/02/django-celery/">Django2结合Celery添加定时任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/31/python3-twisted-web-client/">python3调用twisted web request的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/01/why-docker-has-OS-image/">Docker的OS image是做什么用的</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/理解python-with语句/">理解python with语句</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/关于目前工作的一点感想/">关于目前工作的一点感想</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/05/python-str-formation/">Python字符串格式化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//dequn-blog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">dequn's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>