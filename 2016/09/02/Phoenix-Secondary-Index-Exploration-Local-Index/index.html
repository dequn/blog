<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="dequn's blog" type="application/atom+xml" />
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>Phoenix Secondary Index初探之Local Index | dequn's blog - 这些文章没啥用</title>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="en"  data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">dequn's blog</a></h1>
        <h2 class="subtitle">这些文章没啥用</h2>
      </div>
      <div class="logo">
        <img src="/images/ARIA_logo.png" alt="logo">
      </div>
    </div>
    
<nav id="nav" class="nav">
  <a id="nav-toggle" class="nav-toggle"><i class="fas fa-bars"></i></a>
  <ul id="menu">
    
    <li><a href="/">Home</a></li>
    
    <li><a href="/archives/">Archives</a></li>
    
    <li><a href="/categories/">Categories</a></li>
    
    <li><a href="/tags/">Tags</a></li>
    
    <li><a href="/about/">About</a></li>
    
  </ul>
</nav>


  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<section id="post" class="post">
  
  <article class="post-container card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://dequn.github.io/2016/09/02/Phoenix-Secondary-Index-Exploration-Local-Index/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
       <meta itemprop="name" content="dequn">
       <meta itemprop="description" content="这些文章没啥用">
       <meta itemprop="image" content="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTL1rxWN2-S8kC34oi2QhbeQdm1hRAhzQTEpm5AFhnG3tJ-ccTI">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="dequn's blog">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
       <span class="">Phoenix Secondary Index初探之Local Index</span>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2016-09-02T20:54:37+08:00">2016-09-02 20:54:37</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Phoenix/" itemprop="url" rel="index"><span itemprop="name">Phoenix</span></a></span>
        </span>
        
        
      </div>
    </header>
    <main class="post-body" itemprop="articleBody">
      <p>上一篇探索了 Phoenix 的 Global Index，这一次来看一看 Local Index 的实现原理。</p>
<p>首先需要说明的是实验采用的 Phoenix 版本号是4.8，从4.8开始，Phoenix 的Local Index 不再采用新建数据表的方式，从官方的描述中可以看出这一点变化：</p>
<blockquote>
<p>Unlike global indexes, all local indexes of a table are stored in a single, separate shared table prior to 4.8.0 version. From 4.8.0 onwards we are storing all local index data in the separate shadow column families in the same data table. </p>
</blockquote>
<p>不过什么是 <strong>shadow column families</strong>? 这一点确实把我弄蒙了，百度 Google 都没有搜出相关的概念，先不管那么多了，先心无旁骛的直奔目标吧。</p>
<p>需要说明的另一点是由于上一次采用的表数据量有些大，在建立 Local Index总是出错，使用 <code>!tables</code> 命令查看索引表总是处于 <strong>BUILDING</strong> 状态，所以这次新建了一个表进行试验，原理明白就好。</p>
<h1 id="1-新建数据表、索引和插入数据"><a href="#1-新建数据表、索引和插入数据" class="headerlink" title="1.新建数据表、索引和插入数据"></a>1.新建数据表、索引和插入数据</h1><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> zdq.test (id BIGINT <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, X INTEGER, Y INTEGER, Z INTEGER, M DECIMAL, N SMALLINT);</span><br><span class="line">ALTER TABLE zdq.test set IMMUTABLE_ROWS = true; # can not set local <span class="keyword">index</span> <span class="keyword">if</span> IMMUTABLE_ROWS = fasle <span class="keyword">or</span> need <span class="keyword">set</span> hbse-site.xml</span><br><span class="line"><span class="keyword">CREATE</span> LOCAL <span class="keyword">INDEX</span> X_IDX <span class="keyword">ON</span> zdq.test (x);</span><br><span class="line"><span class="keyword">CREATE</span> LOCAL <span class="keyword">INDEX</span> Y_IDX <span class="keyword">ON</span> zdq.test (y);</span><br><span class="line"><span class="keyword">CREATE</span> LOCAL <span class="keyword">INDEX</span> Z_IDX <span class="keyword">ON</span> zdq.test (z);</span><br><span class="line"><span class="keyword">UPSERT</span> <span class="keyword">INTO</span> zdq.test (id, x, y, z, m, n) <span class="keyword">VALUES</span> (<span class="number">12345</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">UPSERT</span> <span class="keyword">INTO</span> zdq.test (id, x, y, z, m, n) <span class="keyword">VALUES</span> (<span class="number">123456</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>使用 <code>!tables</code> 查看一下数据表，发现多了<strong>四个表</strong>,一个主数据表，三个索引表。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+-------------+---------------+----------+------------+----------------------------+-----------------+--------------+-----------------+---------------+---------------+--------+</span><br><span class="line">|<span class="string"> TABLE_CAT  </span>|<span class="string"> TABLE_SCHEM  </span>|<span class="string"> TABLE_NAME  </span>|<span class="string">  TABLE_TYPE   </span>|<span class="string"> REMARKS  </span>|<span class="string"> TYPE_NAME  </span>|<span class="string"> SELF_REFERENCING_COL_NAME  </span>|<span class="string"> REF_GENERATION  </span>|<span class="string"> INDEX_STATE  </span>|<span class="string"> IMMUTABLE_ROWS  </span>|<span class="string"> SALT_BUCKETS  </span>|<span class="string"> MULTI_TENANT  </span>|<span class="string"> VIEW_S </span>|</span><br><span class="line">+------------+--------------+-------------+---------------+----------+------------+----------------------------+-----------------+--------------+-----------------+---------------+---------------+--------+</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> X_IDX       </span>|<span class="string"> INDEX         </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string"> ACTIVE       </span>|<span class="string"> true            </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Y_IDX       </span>|<span class="string"> INDEX         </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string"> ACTIVE       </span>|<span class="string"> true            </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Z_IDX       </span>|<span class="string"> INDEX         </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string"> ACTIVE       </span>|<span class="string"> true            </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> SYSTEM       </span>|<span class="string"> CATALOG     </span>|<span class="string"> SYSTEM TABLE  </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> false           </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> SYSTEM       </span>|<span class="string"> FUNCTION    </span>|<span class="string"> SYSTEM TABLE  </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> false           </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> SYSTEM       </span>|<span class="string"> SEQUENCE    </span>|<span class="string"> SYSTEM TABLE  </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> false           </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> SYSTEM       </span>|<span class="string"> STATS       </span>|<span class="string"> SYSTEM TABLE  </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> false           </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> BIGJOY       </span>|<span class="string"> IMOS        </span>|<span class="string"> TABLE         </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> true            </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> TEST        </span>|<span class="string"> TABLE         </span>|<span class="string">          </span>|<span class="string">            </span>|<span class="string">                            </span>|<span class="string">                 </span>|<span class="string">              </span>|<span class="string"> true            </span>|<span class="string"> null          </span>|<span class="string"> false         </span>|<span class="string">        </span>|</span><br><span class="line">+------------+--------------+-------------+---------------+----------+------------+----------------------------+-----------------+--------------+-----------------+---------------+---------------+--------+</span><br></pre></td></tr></table></figure>
<p>在 HBase Shell 中使用 <code>list</code> 命令查看一下，<strong>和 Global Index 不一样的是，只多出了一个表 ‘ZDQ.TEST’</strong>。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">001</span>:<span class="number">0</span>&gt; list</span><br><span class="line">TABLE</span><br><span class="line">BIGJOY.IMOS</span><br><span class="line">BIGJOY.POIS</span><br><span class="line">BIGJOY.POIS_MAC_IDX</span><br><span class="line">SYSTEM.CATALOG</span><br><span class="line">SYSTEM.FUNCTION</span><br><span class="line">SYSTEM.SEQUENCE</span><br><span class="line">SYSTEM.STATS</span><br><span class="line">ZDQ.TEST</span><br><span class="line"><span class="number">8</span> row(s) <span class="keyword">in</span> <span class="number">0.2320</span> seconds</span><br><span class="line"></span><br><span class="line">=&gt; [<span class="string">"BIGJOY.IMOS"</span>, <span class="string">"BIGJOY.POIS"</span>, <span class="string">"BIGJOY.POIS_MAC_IDX"</span>, <span class="string">"SYSTEM.CATALOG"</span>, <span class="string">"SYSTEM.FUNCTION"</span>, <span class="string">"SYSTEM.SEQUENCE"</span>, <span class="string">"SYSTEM.STATS"</span>, <span class="string">"ZDQ.TEST"</span>]</span><br><span class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">002</span>:<span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>
<h1 id="2-数据表、索引表结构探究"><a href="#2-数据表、索引表结构探究" class="headerlink" title="2.数据表、索引表结构探究"></a>2.数据表、索引表结构探究</h1><p>查看三个索引表的主键！<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:phoenix:localhost&gt; !primarykeys zdq.z_idx</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string"> TABLE_CAT  </span>|<span class="string"> TABLE_SCHEM  </span>|<span class="string"> TABLE_NAME  </span>|<span class="string"> COLUMN_NAME  </span>|<span class="string"> KEY_SEQ  </span>|<span class="string"> PK_NAME  </span>|<span class="string"> ASC_OR_DESC  </span>|<span class="string"> DATA_TYPE  </span>|<span class="string"> TYPE_NAME  </span>|<span class="string"> COLUMN_SIZE  </span>|<span class="string"> TYPE_ID  </span>|<span class="string"> VIEW_CONSTANT  </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Z_IDX       </span>|<span class="string"> 0:Z          </span>|<span class="string"> 2        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 3          </span>|<span class="string"> DECIMAL    </span>|<span class="string"> null         </span>|<span class="string"> 3        </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Z_IDX       </span>|<span class="string"> :ID          </span>|<span class="string"> 3        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> -5         </span>|<span class="string"> BIGINT     </span>|<span class="string"> null         </span>|<span class="string"> -5       </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Z_IDX       </span>|<span class="string"> _INDEX_ID    </span>|<span class="string"> 1        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 5          </span>|<span class="string"> SMALLINT   </span>|<span class="string"> null         </span>|<span class="string"> 5        </span>|<span class="string">                </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">0: jdbc:phoenix:localhost&gt; !primarykeys zdq.x_idx</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string"> TABLE_CAT  </span>|<span class="string"> TABLE_SCHEM  </span>|<span class="string"> TABLE_NAME  </span>|<span class="string"> COLUMN_NAME  </span>|<span class="string"> KEY_SEQ  </span>|<span class="string"> PK_NAME  </span>|<span class="string"> ASC_OR_DESC  </span>|<span class="string"> DATA_TYPE  </span>|<span class="string"> TYPE_NAME  </span>|<span class="string"> COLUMN_SIZE  </span>|<span class="string"> TYPE_ID  </span>|<span class="string"> VIEW_CONSTANT  </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> X_IDX       </span>|<span class="string"> 0:X          </span>|<span class="string"> 2        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 3          </span>|<span class="string"> DECIMAL    </span>|<span class="string"> null         </span>|<span class="string"> 3        </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> X_IDX       </span>|<span class="string"> :ID          </span>|<span class="string"> 3        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> -5         </span>|<span class="string"> BIGINT     </span>|<span class="string"> null         </span>|<span class="string"> -5       </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> X_IDX       </span>|<span class="string"> _INDEX_ID    </span>|<span class="string"> 1        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 5          </span>|<span class="string"> SMALLINT   </span>|<span class="string"> null         </span>|<span class="string"> 5        </span>|<span class="string">                </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">0: jdbc:phoenix:localhost&gt; !primarykeys zdq.y_idx</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string"> TABLE_CAT  </span>|<span class="string"> TABLE_SCHEM  </span>|<span class="string"> TABLE_NAME  </span>|<span class="string"> COLUMN_NAME  </span>|<span class="string"> KEY_SEQ  </span>|<span class="string"> PK_NAME  </span>|<span class="string"> ASC_OR_DESC  </span>|<span class="string"> DATA_TYPE  </span>|<span class="string"> TYPE_NAME  </span>|<span class="string"> COLUMN_SIZE  </span>|<span class="string"> TYPE_ID  </span>|<span class="string"> VIEW_CONSTANT  </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Y_IDX       </span>|<span class="string"> 0:Y          </span>|<span class="string"> 2        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 3          </span>|<span class="string"> DECIMAL    </span>|<span class="string"> null         </span>|<span class="string"> 3        </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Y_IDX       </span>|<span class="string"> :ID          </span>|<span class="string"> 3        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> -5         </span>|<span class="string"> BIGINT     </span>|<span class="string"> null         </span>|<span class="string"> -5       </span>|<span class="string">                </span>|</span><br><span class="line">|<span class="string">            </span>|<span class="string"> ZDQ          </span>|<span class="string"> Y_IDX       </span>|<span class="string"> _INDEX_ID    </span>|<span class="string"> 1        </span>|<span class="string">          </span>|<span class="string"> A            </span>|<span class="string"> 5          </span>|<span class="string"> SMALLINT   </span>|<span class="string"> null         </span>|<span class="string"> 5        </span>|<span class="string">                </span>|</span><br><span class="line">+------------+--------------+-------------+--------------+----------+----------+--------------+------------+------------+--------------+----------+----------------+</span><br></pre></td></tr></table></figure></p>
<p>发现三个索引表中除了<strong>被索引的字段</strong>字段不同外，其他组成并且在主键中的顺序都是一样的，下面看一下执行计划！</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:phoenix:localhost&gt; explain select * <span class="keyword">from</span> zdq.test where x = 1;</span><br><span class="line">+---------------------------------------------------------------------------+</span><br><span class="line">|                                   PLAN                                    |</span><br><span class="line">+---------------------------------------------------------------------------+</span><br><span class="line">|<span class="built_in"> CLIENT </span>1-CHUNK PARALLEL 1-WAY ROUND ROBIN RANGE SCAN OVER ZDQ.TEST [1,1]  |</span><br><span class="line">|    <span class="built_in"> SERVER FILTER </span>BY FIRST KEY ONLY                                       |</span><br><span class="line">+---------------------------------------------------------------------------+</span><br><span class="line">2 rows selected (0.064 seconds)</span><br><span class="line">0: jdbc:phoenix:localhost&gt; explain select * <span class="keyword">from</span> zdq.test where y &gt; 3;</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br><span class="line">|                                       PLAN                                        |</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br><span class="line">|<span class="built_in"> CLIENT </span>1-CHUNK PARALLEL 1-WAY ROUND ROBIN RANGE SCAN OVER ZDQ.TEST [2,3] - [2,*]  |</span><br><span class="line">|    <span class="built_in"> SERVER FILTER </span>BY FIRST KEY ONLY                                               |</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br><span class="line">2 rows selected (0.067 seconds)</span><br><span class="line">0: jdbc:phoenix:localhost&gt; explain select * <span class="keyword">from</span> zdq.test where z &lt; 2;</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br><span class="line">|                                       PLAN                                        |</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br><span class="line">|<span class="built_in"> CLIENT </span>1-CHUNK PARALLEL 1-WAY ROUND ROBIN RANGE SCAN OVER ZDQ.TEST [3,*] - [3,2]  |</span><br><span class="line">|    <span class="built_in"> SERVER FILTER </span>BY FIRST KEY ONLY                                               |</span><br><span class="line">+-----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>从给出的执行计划中可以看出，三次查询都是进行的<strong>RANGE SCAN</strong>,但是注意到 <code>[1,1],[2,3] - [2,*],[3,*] - [3,2]</code>的不同，虽然对其中含义不完全确定，可以知道的是中括号的第二个数和查询约束相关，第一个数吗，是索引建立的顺序？这样也可以与索引表的 primary key 组成的<code>_INDEX_ID</code>的字面意义对应，猜测而已，接下来看一下在 HBase Shell 中的结果吧！</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):004:0&gt; scan 'ZDQ.TEST'</span><br><span class="line">ROW                                                  COLUMN+CELL</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>C1<span class="symbol">\x</span>02<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009      column=L#0:_0, timestamp=1472824360985, value=_0</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>C1<span class="symbol">\x</span>05<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@   column=L#0:_0, timestamp=1472824362230, value=_0</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>C1<span class="symbol">\x</span>03<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009      column=L#0:_0, timestamp=1472824360985, value=_0</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>C1<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@   column=L#0:_0, timestamp=1472824362230, value=_0</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>02<span class="symbol">\x</span>C1<span class="symbol">\x</span>04<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009      column=L#0:_0, timestamp=1472824360985, value=_0</span><br><span class="line"> <span class="symbol">\x</span>00<span class="symbol">\x</span>02<span class="symbol">\x</span>C1<span class="symbol">\x</span>07<span class="symbol">\x</span>00<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@   column=L#0:_0, timestamp=1472824362230, value=_0</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:M, timestamp=1472824360985, value=<span class="symbol">\x</span>C1<span class="symbol">\x</span>02</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:N, timestamp=1472824360985, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:X, timestamp=1472824360985, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:Y, timestamp=1472824360985, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>02</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:Z, timestamp=1472824360985, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>03</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>0009                          column=0:_0, timestamp=1472824360985, value=x</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:M, timestamp=1472824362230, value=<span class="symbol">\x</span>C1<span class="symbol">\x</span>03</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:N, timestamp=1472824362230, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>01</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:X, timestamp=1472824362230, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>04</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:Y, timestamp=1472824362230, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>05</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:Z, timestamp=1472824362230, value=<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>06</span><br><span class="line"> <span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>01<span class="symbol">\x</span>E2@                       column=0:_0, timestamp=1472824362230, value=x</span><br><span class="line">8 row(s) in 0.0570 seconds</span><br></pre></td></tr></table></figure>
<p>注意到，我们只插入了两行，应该只有两个主键才对，HBase Shell 中我们看到了<strong>8个主键</strong>,含有<code>0:M,0:N,0:X,0:Y,0:Z</code>的两行无疑是我们执行 <code>UPSERT</code> 命令插入的，剩下的六行是什么鬼？</p>
<p>以<code>\x00\x00\xC1\x02\x00\x80\x00\x00\x00\x00\x0009</code> 和 <code>\x00\x00\xC1\x05\x00\x80\x00\x00\x00\x00\x01\xE2@</code> 为例，很快我们就可以发现这两行的后半截 <code>\x80\x00\x00\x00\x00\x0009</code> 就是原数据表的主键了，这与 <code>!primarykeys</code> 中看到的 <code>:ID</code>的 <code>KEY_SEQ = 3</code> 是一致的。</p>
<p>剩下前边的 <code>\x00\x00\xC1\x02\x00</code> 和 <code>\x00\x00\xC1\x05\x00</code> ,不过代表什么意思就得猜了，索引表主键查看的结果中，被索引字段(姑且还这么叫吧)是被放在了第二位的 <code>KEY_SEQ = 2</code> ，并且是 <code>Decimal</code>类型的，这就是为什么在创建表的时候多了一个 Decimal 类型的字段 <code>M</code>,在 HBase Shell 中的查询结果有这么一行<code>\x80\x00\x00\x00\x00\x00\x04\xD2                    column=0:M, timestamp=1472822139596, value=\xC1\x02</code>,看 M 的值对比<code>\x00\x00\xC1\x02\x00</code>，发现出后边多了一个 <code>\x00</code>之外，其余是吻合的，即 X = M，前缀 <code>\x00\x00</code> <code>\x00\x01</code> <code>\x00\x02</code> 应该就是三个索引的编号了，如果在创建第四个索引，就还会多出 N 行，N 为原始数据的行数，经过实践确实如此，只是中间的一个 <code>\x00</code> 是做什么用的还不清楚！</p>
<p>从这里大概可以猜出 <strong>shadow column families</strong>的意思了，应该就是指在同一个表中添加主键构成不同的行作为索引。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h1><p>经过以上实验，总结 Phoenix 的 Local Index ：</p>
<ul>
<li>从 Phoenix 4.8 版本开始，Local Index 和原始数据是存在于一个表中的！</li>
<li>Local Index 先范围扫描约束，根据得到的 <code>:ID</code> 再查询原始数据，所以 Local Index 是可以用在任意字段的查询中都有作用！</li>
<li>shadow column families 应该就是一个小 trick 而已，弄得概念很高大上，如果我理解错了还望指正。</li>
<li>Local Index 查询至少经过一次 RANGE SCAN 和 GET ，所以效率上肯定不如 Global Index 高。</li>
<li>疑问1：Local Index 是保证了索引表和原始表在同一个 RegionServer 上的，如果在一个表中，行健组成又不同，Phoenix 是如何实现这一点的？</li>
<li>官方文档说：如果一个 Local Index 被使用，所用的 Region 都要被检查是否有满足约束的数据，所以读取效率很低呐！</li>
</ul>
<p>最后，发现 Phoenix 把各种 Data Type 的都变成 Hexacdemical 字符串了，很不利于人来查看，虽然在 Phoenix 的交互命令行中是类如 RDMBS 的可读的，但在这次实验中也发现了这些 Hexacdemical 太不友好，如果有必要并且找到比较好的解决方案的话，大家给提供些帮助如何使 hexacdemical readable?</p>

    </main>
    <footer class="post-footer">
      
      
      <div class="post-tags">
        
        
        
        
        <a class="post-tag button" href="/tags/HBase/" style="background: #fc6423;" rel="tag"><i class="fas fa-tags"></i>HBase</a>
        
        <a class="post-tag button" href="/tags/Secondary-Index/" style="background: #a3bb54;" rel="tag"><i class="fas fa-tags"></i>Secondary Index</a>
        
        <a class="post-tag button" href="/tags/Phoenix/" style="background: #47aaff;" rel="tag"><i class="fas fa-tags"></i>Phoenix</a>
        
        <a class="post-tag button" href="/tags/Local-Index/" style="background: #fc6423;" rel="tag"><i class="fas fa-tags"></i>Local Index</a>
        
      </div>
      
    </footer>
  </article>
  
  
<div class="reward" id="reward">
  <p>坚持原创技术分享，您的支持是我前进的动力！</p>
  <button id="reward-button" class="button" disable="enable">Reward</button>
  <div id="qr" class="qr" style="display: none;">
    
    
    
  </div>
</div>


  
  
  <div class="post-nav">
    <div class="post-nav-next post-nav-item">
      
      <a href="/2016/08/29/Phoenix-Secondary-Index-Exploration-Global-Index/" rel="next" title="Phoenix Secondary Index初探之Global Index"><i class="fas fa-angle-left"></i><span class="nav-title">Phoenix Secondary Index初探之Global Index</span></a>
      
    </div>
    <div class="post-nav-prev post-nav-item">
      
      <a href="/2016/10/07/phoenix-mapreduce-example/" rel="prev" title="用 Phoenix 跑 MapReduce 任务-官方例子"><span class="nav-title">用 Phoenix 跑 MapReduce 任务-官方例子</span><i class="fas fa-angle-right"></i></a>
      
    </div>
  </div>
  
  
</section>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/sidebar_background.png);">
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTL1rxWN2-S8kC34oi2QhbeQdm1hRAhzQTEpm5AFhnG3tJ-ccTI" alt="dequn">
  
  <h1 class="author-name">dequn</h1>
  <h2 class="author-description"> 这些文章没啥用</h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">Archives</div>
      <div><a href="/archives/">41</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="categories-count">
      <div class="site-count-title">Categories</div>
      <div><a href="/categories/">11</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="tags-count">
      <div class="site-count-title">Tags</div>
      <div><a href="/tags/">53</a></div>
    </div>
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    




<hr>
<div class="post-toc sidebar-item" id="toc-div">
  <div><i class="fas fa-list-ol"></i>Table of Contents</div>
  <div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-新建数据表、索引和插入数据"><span class="toc-text">1.新建数据表、索引和插入数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-数据表、索引表结构探究"><span class="toc-text">2.数据表、索引表结构探究</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-总结"><span class="toc-text">3.总结</span></a></li></ol></div>
</div>



    
    
    
<hr>
<div class="social-link sidebar-item">
  <div><i class="far fa-address-card"></i>Social Links</p></div>
  <ul>
    
    <li><i class="fas fa-envelope"></i><a href="mailto:dqzhangchn@gmail.com" target="_blank">E-Mail</a></li>
    
    <li><i class="fab fa-github"></i><a href="https://github.com/dequn" target="_blank">GitHub</a></li>
    
  </ul>
</div>


    
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <a id="back-to-top"><i class="fas fa-angle-double-up"></i></a>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">dequn</span><span class="year"><i class="far fa-copyright"></i>2018</span>
        </div>
        
        
<div class="busuanzi">
  <span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv"></span></span>
</div>


        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          Proudly Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> | Theme is <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
